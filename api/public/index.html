<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø¯Ø§Ø© ØªØ³Ø¹ÙŠØ± COD Pro + Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 16px; outline: none; transition: 0.3s; box-sizing: border-box; }
        input:focus { border-color: var(--primary); }
        .results { background: #1e293b; color: white; padding: 20px; border-radius: 15px; margin-top: 20px; }
        .res-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1em; }
        .total { font-size: 1.5em; font-weight: bold; border-top: 1px solid #475569; padding-top: 10px; color: #4ade80; }
        
        /* Ø²Ø± Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… */
        .chat-btn { position: fixed; bottom: 20px; left: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 30px; cursor: pointer; box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: transform 0.3s; }
        .chat-btn:hover { transform: scale(1.1); }
        
        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø§Øª */
        .chat-window { display: none; position: fixed; bottom: 90px; left: 20px; width: 350px; height: 500px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden; z-index: 1001; border: 1px solid #e5e7eb; }
        .chat-header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f9fafb; font-size: 0.9em; }
        .chat-footer { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; background: white; }
        .chat-footer input { border: 1px solid #ddd; padding: 10px; border-radius: 20px; }
        .msg { padding: 8px 12px; margin: 5px 0; border-radius: 15px; max-width: 80%; line-height: 1.4; }
        .user-msg { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; }
        .bot-msg { background: #e5e7eb; color: black; align-self: flex-start; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ğŸ‡©ğŸ‡¿ COD</h1>
    
    <div class="grid">
        <div class="input-group">
            <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (DZD)</label>
            <input type="number" id="selling_price" oninput="calculate()" placeholder="Ù…Ø«Ù„Ø§Ù‹ 5900">
        </div>
        <div class="input-group">
            <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (DZD)</label>
            <input type="number" id="product_cost" oninput="calculate()" placeholder="Ù…Ø«Ù„Ø§Ù‹ 2500">
        </div>
    </div>

    <div class="grid">
        <div class="input-group">
            <label>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª (Ù„Ù„Ù…Ø¨ÙŠØ¹Ø©)</label>
            <input type="number" id="ad_cost" oninput="calculate()" placeholder="Ù…Ø«Ù„Ø§Ù‹ 600">
        </div>
        <div class="input-group">
            <label>ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙˆØµÙŠÙ„ (DZD)</label>
            <input type="number" id="delivery_cost" oninput="calculate()" placeholder="Ù…Ø«Ù„Ø§Ù‹ 800">
        </div>
    </div>

    <div class="input-group">
        <label>Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Confirmation %)</label>
        <input type="number" id="conf_rate" oninput="calculate()" value="70" placeholder="70">
    </div>

    <div class="results">
        <div class="res-row"><span>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙˆØªÙˆØ±):</span> <span id="gross_profit">0 DZD</span></div>
        <div class="res-row"><span>Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØªÙˆØ± (Retour):</span> <span id="return_loss" style="color: #f87171;">0 DZD</span></div>
        <div class="res-row total"><span>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ:</span> <span id="net_profit">0 DZD</span></div>
        <div class="res-row" style="margin-top: 10px; font-size: 0.9em; color: #94a3b8;">
            <span>Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ (ROI):</span> <span id="roi_res">0%</span>
        </div>
    </div>
</div>

<!-- Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª -->
<button class="chat-btn" onclick="toggleChat()">ğŸ’¬</button>

<div class="chat-window" id="chatWindow">
    <div class="chat-header">
        <span>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ ğŸ¤–</span>
        <span style="cursor: pointer;" onclick="toggleChat()">âœ–</span>
    </div>
    <div class="chat-body" id="chatBody">
        <div class="msg bot-msg">Ù…Ø±Ø­Ø¨Ø§! Ø£Ù†Ø§ Ù‡Ù†Ø§ Ø¨Ø§Ø´ Ù†Ø¹Ø§ÙˆÙ†Ùƒ ÙÙŠ Ø­Ø³Ø§Ø¨Ø§ØªÙƒ Ø£Ùˆ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹. ÙˆØ§Ø´ ØªØ­Ø¨ ØªØ³Ù‚Ø³ÙŠØŸ</div>
    </div>
    <div class="chat-footer">
        <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ..." onkeypress="handleEnter(event)">
        <button onclick="sendMessage()" style="background:none; border:none; cursor:pointer;">â¤</button>
    </div>
</div>

<script>
    // 1. ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø©
    function calculate() {
        // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ…
        let price = parseFloat(document.getElementById('selling_price').value) || 0;
        let cost = parseFloat(document.getElementById('product_cost').value) || 0;
        let ad = parseFloat(document.getElementById('ad_cost').value) || 0;
        let delivery = parseFloat(document.getElementById('delivery_cost').value) || 0;
        let rate = parseFloat(document.getElementById('conf_rate').value) || 0;

        // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        // 1. Ø§Ù„Ø±Ø¨Ø­ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­
        let profit_per_sale = price - cost - delivery - ad;
        
        // 2. Ø§Ù„Ø®Ø³Ø§Ø±Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙˆØªÙˆØ± (Ù†Ø®Ø³Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† + Ø§Ù„ØªÙˆØµÙŠÙ„ + ÙˆØªØºÙ„ÙŠÙ Ø£Ø­ÙŠØ§Ù†Ø§Ù‹)
        // Ø³Ù†ÙØªØ±Ø¶ Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† + Ù†ØµÙ Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø±ÙˆØªÙˆØ±)
        let loss_per_return = ad + (delivery * 0.5); 

        // 3. Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ 100 Ø·Ù„Ø¨ÙŠØ© Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ÙÙ‡Ù…
        let delivered = 100 * (rate / 100);
        let returned = 100 - delivered;

        let total_gain = delivered * profit_per_sale;
        let total_loss = returned * loss_per_return;
        let final_net = (total_gain - total_loss) / 100; // Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆØ³Ø· Ù„Ù„Ù…Ø¨ÙŠØ¹Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        document.getElementById('gross_profit').innerText = profit_per_sale.toFixed(0) + " DZD";
        document.getElementById('return_loss').innerText = "-" + loss_per_return.toFixed(0) + " DZD";
        document.getElementById('net_profit').innerText = final_net.toFixed(0) + " DZD";
        
        let roi = 0;
        if ((cost + ad + delivery) > 0) {
            roi = (final_net / (cost + ad + delivery)) * 100;
        }
        document.getElementById('roi_res').innerText = roi.toFixed(1) + "%";
    }

    // 2. ÙƒÙˆØ¯ Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª
    function toggleChat() {
        let win = document.getElementById('chatWindow');
        win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        let input = document.getElementById('chatInput');
        let body = document.getElementById('chatBody');
        let txt = input.value.trim();
        if (!txt) return;

        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        body.innerHTML += `<div class="msg user-msg">${txt}</div>`;
        input.value = '';
        body.scrollTop = body.scrollHeight;

        try {
            // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
            let res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: txt })
            });

            let data = await res.json();
            
            // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª
            body.innerHTML += `<div class="msg bot-msg">${data.reply || "Ø­Ø¯Ø« Ø®Ø·Ø£"}</div>`;
        } catch (error) {
            body.innerHTML += `<div class="msg bot-msg" style="color:red">ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª API</div>`;
        }
        body.scrollTop = body.scrollHeight;
    }
</script>

</body>
</html>
